from datetime import timedelta

from app.models.license import LicensePlan, LicenseStatus
from app.models.user import User, UserRole
from app.services.license_service import LicenseService


def create_user(session):
    user = User(email="user@example.com", hashed_password="hashed", role=UserRole.USER)
    session.add(user)
    session.commit()
    session.refresh(user)
    return user


def test_create_license_sets_duration_and_status(db_session):
    user = create_user(db_session)
    service = LicenseService(db_session)

    license_obj = service.create_license(user_id=user.id, issued_by_id=None, plan=LicensePlan.ONE_DAY)

    assert license_obj.status == LicenseStatus.ACTIVE
    assert license_obj.duration == timedelta(days=1)
    assert license_obj.expires_at > license_obj.starts_at


def test_ensure_session_link_idempotent(db_session):
    user = create_user(db_session)
    service = LicenseService(db_session)
    license_obj = service.create_license(user_id=user.id, issued_by_id=None, plan=LicensePlan.ONE_HOUR)

    link1 = service.ensure_session_link(license_obj)
    link2 = service.ensure_session_link(license_obj)

    assert link1.id == link2.id
    assert link1.slug == link2.slug


def test_touch_session_link_updates_runtime(db_session):
    user = create_user(db_session)
    service = LicenseService(db_session)
    license_obj = service.create_license(user_id=user.id, issued_by_id=None, plan=LicensePlan.ONE_HOUR)
    link = service.ensure_session_link(license_obj)

    updated = service.touch_session_link(link, runtime_increment=120)

    assert updated.total_runtime_seconds == 120
    assert updated.last_seen is not None
