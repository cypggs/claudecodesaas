from datetime import datetime, timedelta

import pytest
from fastapi.testclient import TestClient
from sqlalchemy.orm import sessionmaker

from app.api.deps import get_db_session
from app.core.security import create_access_token
from app.main import app
from app.models.license import LicensePlan
from app.models.session_link import SessionLink
from app.models.user import User, UserRole
from app.services.license_service import LicenseService
from app.services.user_service import UserService


@pytest.fixture()
def session_factory(db_engine):
    return sessionmaker(autocommit=False, autoflush=False, bind=db_engine)


@pytest.fixture()
def client(session_factory, monkeypatch):
    def override_db():
        session = session_factory()
        try:
            yield session
        finally:
            session.close()

    app.dependency_overrides[get_db_session] = override_db

    class DummyScheduler:
        def shutdown(self, wait: bool = False) -> None:
            return None

    monkeypatch.setattr("app.main.start_scheduler", lambda: DummyScheduler())
    return TestClient(app)


@pytest.fixture()
def seed_user_and_license(session_factory):
    session = session_factory()
    try:
        user_service = UserService(session)
        license_service = LicenseService(session)
        admin = user_service.create_user(email="admin@example.com", password="AdminPass123!", role=UserRole.ADMIN)
        user = user_service.create_user(email="user@example.com", password="UserPass123!", role=UserRole.USER)
        license_obj = license_service.create_license(
            user_id=user.id,
            issued_by_id=admin.id,
            plan=LicensePlan.ONE_HOUR,
            starts_at=datetime.utcnow(),
            duration_override=timedelta(minutes=90),
        )
        link = license_service.ensure_session_link(license_obj)
        session.commit()
        yield {
            "admin": admin,
            "user": user,
            "license": license_obj,
            "link": link,
        }
    finally:
        session.close()


def test_get_session_link_requires_active_license(client, seed_user_and_license):
    user = seed_user_and_license["user"]
    token = create_access_token(str(user.id), additional_claims={"role": user.role.value, "type": "access"})

    response = client.post(
        "/api/v1/sessions/current",
        headers={"Authorization": f"Bearer {token}"},
    )

    assert response.status_code == 200
    payload = response.json()
    assert payload["slug"] == seed_user_and_license["link"].slug


def test_forward_messages_updates_runtime(client, session_factory, seed_user_and_license, monkeypatch):
    session_link = seed_user_and_license["link"]

    async def fake_invoke_claude(*, messages, model="claude-3-opus-20240229", temperature=0.2):
        return {"id": "test", "messages": messages, "model": model, "temperature": temperature}

    monkeypatch.setattr("app.api.routes.claude.invoke_claude", fake_invoke_claude)

    response = client.post(
        f"/api/v1/claude/sessions/{session_link.slug}/messages",
        json={"messages": [{"role": "user", "content": "print('hello')"}], "runtime_increment": 30},
    )

    assert response.status_code == 200
    body = response.json()
    assert body["id"] == "test"

    session = session_factory()
    try:
        refreshed = session.query(SessionLink).filter(SessionLink.id == session_link.id).one()
        assert refreshed.total_runtime_seconds == 30
    finally:
        session.close()
