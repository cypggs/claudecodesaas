from typing import List

from fastapi import APIRouter, Depends, HTTPException, status

from app.api.deps import get_current_admin, get_db_session
from app.models.user import User
from app.schemas.license import LicenseCreate, LicenseRead
from app.schemas.user import UserRead
from app.services.license_service import LicenseService
from app.services.user_service import UserService

router = APIRouter(prefix="/admin", tags=["admin"], dependencies=[Depends(get_current_admin)])


@router.get("/users", response_model=List[UserRead])
def list_users(db=Depends(get_db_session)) -> list[UserRead]:
    service = UserService(db)
    return [UserRead.model_validate(user) for user in service.list_users()]


@router.post("/users/{user_id}/licenses", response_model=LicenseRead, status_code=status.HTTP_201_CREATED)
def issue_license(user_id: str, payload: LicenseCreate, current_admin: User = Depends(get_current_admin), db=Depends(get_db_session)) -> LicenseRead:
    user_service = UserService(db)
    user = user_service.get(user_id)
    if not user:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="User not found")
    license_service = LicenseService(db)
    license_obj = license_service.create_license(
        user_id=user.id,
        issued_by_id=current_admin.id,
        plan=payload.plan,
        starts_at=payload.starts_at,
        duration_override=payload.duration_override,
    )
    return LicenseRead.model_validate(license_obj)


@router.get("/users/{user_id}/licenses", response_model=List[LicenseRead])
def list_user_licenses(user_id: str, db=Depends(get_db_session)) -> list[LicenseRead]:
    license_service = LicenseService(db)
    return [LicenseRead.model_validate(item) for item in license_service.list_for_user(user_id)]
