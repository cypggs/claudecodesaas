from typing import Any, Dict, List

import httpx
from fastapi import HTTPException, status

from app.core.config import settings

DEFAULT_TIMEOUT = httpx.Timeout(120.0, connect=30.0)


async def invoke_claude(*, messages: List[Dict[str, Any]], model: str = "claude-3-opus-20240229", temperature: float = 0.2) -> Dict[str, Any]:
    payload = {
        "model": model,
        "messages": messages,
        "temperature": temperature,
        "max_tokens": 4096,
    }
    base_url = settings.ANTHROPIC_BASE_URL.rstrip("/")
    transport = httpx.AsyncHTTPTransport(retries=3)
    headers = {
        "x-api-key": settings.ANTHROPIC_AUTH_TOKEN,
        "content-type": "application/json",
    }

    try:
        async with httpx.AsyncClient(
            base_url=base_url,
            headers=headers,
            timeout=DEFAULT_TIMEOUT,
            transport=transport,
        ) as client:
            response = await client.post("/v1/messages", json=payload)
    except httpx.ConnectTimeout as exc:
        raise HTTPException(status_code=status.HTTP_504_GATEWAY_TIMEOUT, detail="Claude 服务连接超时，请稍后重试或联系管理员") from exc
    except httpx.HTTPError as exc:
        raise HTTPException(status_code=status.HTTP_502_BAD_GATEWAY, detail=f"Claude 服务请求失败: {exc}") from exc

    if response.status_code >= 400:
        if response.headers.get("content-type", "").startswith("application/json"):
            detail = response.json()
        else:
            detail = response.text or "Claude 服务返回错误"
        raise HTTPException(status_code=response.status_code, detail=detail)
    return response.json()
