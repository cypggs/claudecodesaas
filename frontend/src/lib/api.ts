import axios from 'axios';

const configuredBase = (import.meta.env.VITE_API_BASE_URL as string | undefined)?.trim();
const API_BASE_URL = configuredBase && configuredBase.length > 0 ? configuredBase.replace(/\/$/, '') : '';

export interface TokenPair {
  accessToken: string;
  refreshToken: string;
}

const apiClient = axios.create({
  baseURL: API_BASE_URL ? `${API_BASE_URL}/api/v1` : '/api/v1',
});

apiClient.interceptors.request.use((config) => {
  const token = typeof window !== 'undefined' ? window.localStorage.getItem('accessToken') : null;
  if (token) {
    config.headers = config.headers ?? {};
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

apiClient.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;
      const refreshToken = typeof window !== 'undefined' ? window.localStorage.getItem('refreshToken') : null;
      if (!refreshToken) {
        return Promise.reject(error);
      }
      try {
        const refreshed = await axios.post(`${API_BASE_URL || ''}/api/v1/auth/refresh`, {
          refresh_token: refreshToken,
        });
        const { access_token, refresh_token } = refreshed.data;
        if (typeof window !== 'undefined') {
          window.localStorage.setItem('accessToken', access_token);
          if (refresh_token) {
            window.localStorage.setItem('refreshToken', refresh_token);
          }
        }
        originalRequest.headers.Authorization = `Bearer ${access_token}`;
        return apiClient(originalRequest);
      } catch (refreshError) {
        if (typeof window !== 'undefined') {
          window.localStorage.removeItem('accessToken');
          window.localStorage.removeItem('refreshToken');
        }
        return Promise.reject(refreshError);
      }
    }
    return Promise.reject(error);
  },
);

export function setTokens(tokens: TokenPair) {
  if (typeof window === 'undefined') return;
  window.localStorage.setItem('accessToken', tokens.accessToken);
  window.localStorage.setItem('refreshToken', tokens.refreshToken);
}

export function clearTokens() {
  if (typeof window === 'undefined') return;
  window.localStorage.removeItem('accessToken');
  window.localStorage.removeItem('refreshToken');
}

export const api = {
  register(payload: { email: string; password: string; full_name?: string }) {
    return apiClient.post('/auth/register', payload);
  },
  login(payload: { email: string; password: string }) {
    return apiClient.post('/auth/login', payload);
  },
  currentUser() {
    return apiClient.get('/auth/me');
  },
  listUsers() {
    return apiClient.get('/admin/users');
  },
  issueLicense(userId: string, payload: { plan: string; starts_at?: string }) {
    return apiClient.post(`/admin/users/${userId}/licenses`, payload);
  },
  ensureSessionLink() {
    return apiClient.post('/sessions/current');
  },
  fetchSession(slug: string) {
    return apiClient.get(`/claude/sessions/${slug}`);
  },
  sendClaudeMessages(slug: string, payload: { messages: Array<{ role: string; content: string }>; runtime_increment?: number }) {
    return apiClient.post(`/claude/sessions/${slug}/messages`, payload);
  },
};
